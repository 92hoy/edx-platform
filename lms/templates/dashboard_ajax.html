<%!
from django.core.urlresolvers import reverse
from django.utils.translation import ugettext as _
from django.template import RequestContext
import third_party_auth
from third_party_auth import pipeline
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML, Text
from microsite_configuration import microsite
%>

<%block name="js_extra">
<script src="${static.url('js/commerce/credit.js')}"></script>
<%static:js group='dashboard'/>
<script type="text/javascript">
    $(document).ready(function () {
        edx.dashboard.legacy.init({
            dashboard: "${reverse('dashboard') | n, js_escaped_string}",
            signInUser: "${reverse('signin_user') | n, js_escaped_string}",
            changeEmailSettings: "${reverse('change_email_settings') | n, js_escaped_string}"
        });


        $(".faq-tab a").click(function (e) {
            console.log("tab clicked: " + e);

            var status = $(this).data("status");

            $(e.target).find(".progress").stop().animate({
                width: "70%"
            }, 5000);

            $.post("/dashboard", {
                "status": status
            }, function (data) {
                $(e.target).find(".progress").stop().animate({
                    width: "100%"
                }, 50, function () {
                    $(".faq-tab .progress").css("width", "0%");

                    $(".faq-tab a").removeClass("on");
                    $(e.target).addClass("on");
                    $("#courses_target").html(data);

                    var status = $(e.target).data("status");


                    $(".sub-end, .sub-interest").slideUp(200);

                    if (status === "end")
                        $(".sub-end").slideDown(400);
                    else if (status === "interest")
                        $(".sub-interest").slideDown(400);

                });

            }).done(function () {
                $(".progress").css("width", "0%");
            });
        });
    });

    function focusTo(type) {
        console.log('type: ' + type);
        switch (type) {
            case 1:
                var target_top = $(".action-certificate:eq(0)").parents("li.course-item").position().top - 120;
                $( 'html, body' ).animate( { scrollTop : target_top }, 500 );
                break;
            case 2:
                var target_top = $(".action-certificate:last").parents("li.course-item").next().position().top - 120;
                $( 'html, body' ).animate( { scrollTop : target_top }, 500 );
                break;
            case 3:
                var target_top = $(".course-container[data-is_enrolled='True']:first").parents("li.course-item").position().top - 120;
                $( 'html, body' ).animate( { scrollTop : target_top }, 500 );
                break;
            case 4:
                var target_top = $(".course-container[data-is_enrolled='False']:first").parents("li.course-item").position().top - 120;
                $( 'html, body' ).animate( { scrollTop : target_top }, 500 );
                break;

            default:
                console.log('focusTo default');
                break;
        }

    }
</script>


% if settings.FEATURES.get('ENABLE_DASHBOARD_SEARCH'):
<%static:require_module module_name="js/search/dashboard/dashboard_search_factory" class_name="DashboardSearchFactory">
DashboardSearchFactory();
</%static:require_module>
% endif
% if redirect_message:
<%static:require_module module_name="js/views/message_banner" class_name="MessageBannerView">
var banner = new MessageBannerView({urgency: 'low', type: 'warning'});
$('#content').prepend(banner.$el);
banner.showMessage(${redirect_message | n, dump_js_escaped_json})
</%static:require_module>
% endif
</%block>



% if len(course_enrollments) > 0:
<ul class="listing-courses" id="default_course">
    <% share_settings = getattr(settings, 'SOCIAL_SHARING_SETTINGS', {}) %>
    % for dashboard_index, enrollment in enumerate(course_enrollments):
    <% show_courseware_link = (enrollment.course_id in show_courseware_links_for) %>
    <% cert_status = cert_statuses.get(enrollment.course_id) %>
    <% can_unenroll = (not cert_status) or cert_status.get('can_unenroll') %>
    <% credit_status = credit_statuses.get(enrollment.course_id) %>
    <% show_email_settings = (enrollment.course_id in show_email_settings_for) %>
    <% course_mode_info = all_course_modes.get(enrollment.course_id) %>
    <% show_refund_option = (enrollment.course_id in show_refund_option_for) %>
    <% is_paid_course = (enrollment.course_id in enrolled_courses_either_paid) %>
    <% is_course_blocked = (enrollment.course_id in block_courses) %>
    <% course_verification_status = verification_status_by_course.get(enrollment.course_id, {}) %>
    <% course_requirements = courses_requirements_not_met.get(enrollment.course_id) %>
    <% course_program_info = course_programs.get(unicode(enrollment.course_id)) %>
    <% percent = percents[str(enrollment.course_id)] %>
    <%include file = 'dashboard/_dashboard_course_listing.html'
    args = "course_overview=enrollment.course_overview,
    enrollment=enrollment,
    show_courseware_link=show_courseware_link,
    cert_status=cert_status,
    can_unenroll=can_unenroll,
    credit_status=credit_status,
    show_email_settings=show_email_settings,
    course_mode_info=course_mode_info,
    show_refund_option=show_refund_option,
    is_paid_course=is_paid_course,
    is_course_blocked=is_course_blocked,
    verification_status=course_verification_status,
    course_requirements=course_requirements,
    dashboard_index=dashboard_index,
    share_settings=share_settings,
    user=user,
    course_program_info=course_program_info,
    percent=percent" />
    % endfor
</ul>

% else:

<div class="empty-dashboard-message">
    <p>${_("You are not enrolled in any courses yet.")}</p>

    % if settings.FEATURES.get('COURSES_ARE_BROWSABLE'):
    <a href="${marketing_link('COURSES')}">
        ${_("Explore courses")}
    </a>
    %endif
</div>
% endif